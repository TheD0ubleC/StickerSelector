{% extends "base.html" %}
{% block content %}
<div class="page-head">
  <div>
    <h1>æ‰¹é‡ä¸Šä¼ ï¼ˆåˆ›å»ºæ‰¹æ¬¡ï¼‰</h1>
    <div class="hint">æ‹–æ‹½æˆ–é€‰æ‹©å›¾ç‰‡æ‰¹é‡ä¸Šä¼ ï¼Œä¸Šä¼ åè¿›å…¥æ‰¹æ¬¡æ‰“ Tagã€‚</div>
  </div>
</div>

<div class="card">
  <form id="uploadForm" method="post" action="/admin/upload" enctype="multipart/form-data" class="row">
    <div class="row grid2">
      <div>
        <label>ä¸Šä¼ åˆ°ç³»åˆ—</label>
        <select name="series_id" required>
          {% for s in series %}
          <option value="{{ s.id }}">{{ s.name }}{% if not s.enabled %}ï¼ˆå·²ç¦ç”¨ï¼‰{% endif %}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label>æ‰¹æ¬¡å¤‡æ³¨ï¼ˆå¯ç©ºï¼‰</label>
        <input name="note" placeholder="æ¯”å¦‚ï¼š2025-12-23 Capoo/æ—©é¤/æç¬‘" />
      </div>
    </div>

    <div class="row">
      <label>é€‰æ‹©å›¾ç‰‡ï¼ˆå¯å¤šé€‰ï¼‰</label>

      <div id="dropzone" class="dropzone" tabindex="0">
        <div class="dropzone-title">æ‹–æ‹½æ–‡ä»¶åˆ°è¿™é‡Œï¼Œæˆ–ç‚¹è¿™é‡Œé€‰æ‹©</div>
        <div class="dropzone-sub">æ”¯æŒï¼špng / jpg / jpeg / gif / webpï¼ˆå•å¼  â‰¤ {{ max_upload_mb }}MBï¼‰</div>
        <input id="fileInput" type="file" name="files" multiple accept="image/*" style="display:none" />
      </div>

      <div id="fileMeta" class="muted" style="margin-top:10px;"></div>
      <div id="preview" class="preview" style="margin-top:10px; display:none;"></div>
    </div>

    <div class="row" id="progressWrap" style="display:none;">
      <label>ä¸Šä¼ è¿›åº¦</label>
      <div class="progress">
        <div id="progressBar" class="progress-bar" style="width:0%"></div>
      </div>
      <div id="progressText" class="muted" style="margin-top:6px;">0%</div>
    </div>

    <div class="row-line">
      <button id="btnUpload" class="btn" type="submit">å¼€å§‹ä¸Šä¼ </button>
      <button id="btnReset" class="btn secondary" type="button">æ¸…ç©ºé€‰æ‹©</button>
    </div>

    <div class="row">
      <div id="msg" class="msg"></div>
    </div>
  </form>
</div>

<style>
  .dropzone-title {
    font-size: 14px;
  }

  .dropzone-sub {
    margin-top: 6px;
    opacity: .75;
    font-size: 12px;
  }

  .preview {
    display: flex;
    flex-wrap: wrap;
    /* ä¸»åŠ¨æ¢è¡Œï¼Œé¿å…æº¢å‡ºå¡ç‰‡ */
    gap: 16px;
    align-items: flex-start;
    justify-content: flex-start;
    max-width: 100%;
  }

  .pv-wrap {
    position: relative;
    border-radius: 12px;
    overflow: hidden;
    width: 100%;
    max-width: 220px;
    /* é™åˆ¶æœ€å¤§å®½åº¦ï¼Œé¿å…åœ¨è¶…å®½å®¹å™¨æ—¶è¿‡åº¦æ‹‰ä¼¸ */
    min-width: 140px;
    /* ä¿è¯æœ€å°å¯è§†å°ºå¯¸ */
    flex: 0 1 160px;
    /* å…è®¸æ”¶ç¼©ä¸æ¢è¡Œï¼Œé»˜è®¤åŸºå‡†å®½åº¦ 160px */
    aspect-ratio: 1 / 1;
    /* ä¿æŒæ­£æ–¹å½¢ */
    display: block;
  }

  .pv {
    width: 100%;
    height: 100%;
    border-radius: 12px;
    object-fit: contain;
    background: rgba(15, 23, 42, .04);
    border: 1px solid rgba(15, 23, 42, .12);
    transition: .15s ease;
    display: block;
  }

  .pv:hover {
    transform: translateY(-1px) scale(1.02);
  }

  .pv-remove {
    position: absolute;
    top: 6px;
    right: 6px;
    width: 22px;
    height: 22px;
    border-radius: 999px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background: rgba(15, 23, 42, .45);
    border: 1px solid rgba(15, 23, 42, .12);
    color: white;
    cursor: pointer;
    font-size: 12px;
  }

  .pv-remove:hover {
    background: rgba(220, 38, 38, .9);
    color: white;
    transform: translateY(-1px);
  }

  .msg {
    white-space: pre-wrap;
    line-height: 1.5;
  }

  .msg.ok {
    color: #15803d;
  }

  .msg.err {
    color: #b91c1c;
  }
</style>

<script>
  (function () {
    const form = document.getElementById("uploadForm");
    const dropzone = document.getElementById("dropzone");
    const input = document.getElementById("fileInput");
    const fileMeta = document.getElementById("fileMeta");
    const preview = document.getElementById("preview");
    const btnUpload = document.getElementById("btnUpload");
    const btnReset = document.getElementById("btnReset");
    const progressWrap = document.getElementById("progressWrap");
    const progressBar = document.getElementById("progressBar");
    const progressText = document.getElementById("progressText");
    const msg = document.getElementById("msg");

    // NOTE: ä¸èƒ½ç»™ input.files ç›´æ¥èµ‹å€¼ï¼ˆå¤§å¤šæ•°æµè§ˆå™¨ä¼šæ— æ•ˆï¼‰
    // æ‰€ä»¥æˆ‘ä»¬è‡ªå·±ç»´æŠ¤ä¸€ä¸ª pickedFiles åˆ—è¡¨ï¼šç‚¹å‡»é€‰æ‹©/æ‹–æ‹½éƒ½å†™å…¥è¿™é‡Œã€‚
    let pickedFiles = [];
    let objectUrls = [];

    function bytes(n) {
      if (!Number.isFinite(n)) return "";
      const u = ["B", "KB", "MB", "GB"];
      let i = 0, x = n;
      while (x >= 1024 && i < u.length - 1) { x /= 1024; i++; }
      return `${x.toFixed(i === 0 ? 0 : 2)} ${u[i]}`;
    }

    function setMsg(text, ok) {
      msg.className = "msg " + (ok ? "ok" : "err");
      msg.textContent = text || "";
    }

    function setFiles(files) {
      const arr = Array.from(files || []);
      if (arr.length === 0) {
        fileMeta.textContent = "æœªé€‰æ‹©ä»»ä½•æ–‡ä»¶";
        preview.style.display = "none";
        preview.innerHTML = "";
        for (const u of objectUrls) { try { URL.revokeObjectURL(u); } catch (e) { } }
        objectUrls = [];
        return;
      }
      const total = arr.reduce((a, f) => a + (f.size || 0), 0);
      const names = arr.slice(0, 8).map(f => f.name).join("ã€");
      const more = arr.length > 8 ? ` â€¦ (+${arr.length - 8})` : "";
      fileMeta.textContent = `å·²é€‰æ‹© ${arr.length} å¼ ï¼Œæ€»å¤§å° ${bytes(total)}ï¼š${names}${more}`;

      // preview
      preview.innerHTML = "";
      for (const u of objectUrls) { try { URL.revokeObjectURL(u); } catch (e) { } }
      objectUrls = [];
      const show = arr.slice(0, 18);
      show.forEach((f, idx) => {
        const url = URL.createObjectURL(f);
        objectUrls.push(url);

        const wrap = document.createElement('div');
        wrap.className = 'pv-wrap';

        const img = document.createElement("img");
        img.className = "pv";
        img.src = url;
        img.title = f.name;

        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'pv-remove';
        btn.title = 'ç§»é™¤';
        btn.textContent = 'âœ•';
        btn.addEventListener('click', () => {
          // remove this file from pickedFiles (use index of the item in arr)
          const globalIndex = pickedFiles.indexOf(f);
          if (globalIndex >= 0) {
            pickedFiles.splice(globalIndex, 1);
            input.value = ""; // clear input FileList to avoid stale data
            setFiles(pickedFiles);
            setMsg(`å·²ç§»é™¤ï¼š${f.name}`, true);
          }
        });

        wrap.appendChild(img);
        wrap.appendChild(btn);
        preview.appendChild(wrap);
      });
      preview.style.display = "flex";
    }

    dropzone.addEventListener("click", () => input.click());
    dropzone.addEventListener("keydown", (e) => { if (e.key === "Enter" || e.key === " ") { e.preventDefault(); input.click(); } });
    input.addEventListener("change", () => {
      pickedFiles = Array.from(input.files || []);
      setFiles(pickedFiles);
    });

    dropzone.addEventListener("dragenter", (e) => { e.preventDefault(); dropzone.classList.add("dragover"); });
    dropzone.addEventListener("dragover", (e) => { e.preventDefault(); dropzone.classList.add("dragover"); });
    dropzone.addEventListener("dragleave", () => dropzone.classList.remove("dragover"));
    dropzone.addEventListener("drop", (e) => {
      e.preventDefault();
      dropzone.classList.remove("dragover");
      if (e.dataTransfer && e.dataTransfer.files) {
        pickedFiles = Array.from(e.dataTransfer.files || []);
        // æ¸…æ‰ input.valueï¼Œé¿å…â€œç‚¹é€‰åä»ç„¶ç”¨æ—§ FileListâ€
        input.value = "";
        setFiles(pickedFiles);
        setMsg(`å·²é€šè¿‡æ‹–æ‹½é€‰æ‹© ${pickedFiles.length} å¼ `, true);
      }
    });

    btnReset.addEventListener("click", () => {
      input.value = "";
      pickedFiles = [];
      setFiles(pickedFiles);
      progressWrap.style.display = "none";
      progressBar.style.width = "0%";
      progressText.textContent = "0%";
      setMsg("");
    });

    form.addEventListener("submit", (e) => {
      e.preventDefault();
      const files = Array.from(pickedFiles && pickedFiles.length ? pickedFiles : (input.files || []));
      if (files.length === 0) {
        setMsg("è¯·å…ˆé€‰æ‹©è¦ä¸Šä¼ çš„å›¾ç‰‡æ–‡ä»¶ã€‚", false);
        return;
      }

      btnUpload.disabled = true;
      btnReset.disabled = true;
      setMsg("å¼€å§‹ä¸Šä¼ â€¦", true);
      progressWrap.style.display = "block";
      progressBar.style.width = "0%";
      progressText.textContent = "0%";

      const fd = new FormData(form);
      fd.delete("files");
      for (const f of files) fd.append("files", f, f.name);

      const xhr = new XMLHttpRequest();
      xhr.open("POST", form.action, true);
      xhr.setRequestHeader("X-Requested-With", "XMLHttpRequest");
      xhr.setRequestHeader("Accept", "application/json");

      xhr.upload.onprogress = (evt) => {
        if (!evt.lengthComputable) return;
        const p = Math.max(0, Math.min(100, Math.round(evt.loaded / evt.total * 100)));
        progressBar.style.width = p + "%";
        progressText.textContent = `${p}%ï¼ˆ${bytes(evt.loaded)} / ${bytes(evt.total)}ï¼‰`;
      };

      xhr.onerror = () => {
        btnUpload.disabled = false;
        btnReset.disabled = false;
        setMsg("ä¸Šä¼ å¤±è´¥ï¼šç½‘ç»œé”™è¯¯æˆ–æœåŠ¡å™¨ä¸å¯è¾¾ã€‚", false);
      };

      xhr.onload = () => {
        btnUpload.disabled = false;
        btnReset.disabled = false;

        let data = null;
        try { data = JSON.parse(xhr.responseText || "{}"); } catch (e) { }

        if (!xhr.status || xhr.status >= 400 || !data || !data.ok) {
          const txt = (data && (data.detail || data.error)) ? (data.detail || data.error) : (xhr.responseText || "");
          setMsg("ä¸Šä¼ å¤±è´¥ï¼š" + (txt || ("HTTP " + xhr.status)), false);
          return;
        }

        const created = data.created ?? 0;
        const skipped = data.skipped ?? [];
        const url = data.redirect_url;

        let lines = [];
        lines.push(`âœ… ä¸Šä¼ å®Œæ¯•ï¼æˆåŠŸï¼š${created} å¼ `);
        if (Array.isArray(skipped) && skipped.length) {
          lines.push(`âš ï¸ è·³è¿‡ï¼š${skipped.length} å¼ `);
          for (const it of skipped.slice(0, 8)) {
            lines.push(`- ${it.file || "(unknown)"}ï¼š${it.reason || "skip"}`);
          }
          if (skipped.length > 8) lines.push(`â€¦ï¼ˆè¿˜æœ‰ ${skipped.length - 8} æ¡æœªå±•ç¤ºï¼‰`);
        }
        lines.push("");
        lines.push("ä½ å¿…é¡»å»æ‰“Tagæ‰èƒ½ç”Ÿæ•ˆ");

        setMsg(lines.join("\n"), true);

        if (url) {
          const a = document.createElement("a");
          a.href = url;
          a.className = "btn";
          a.style.display = "inline-block";
          a.style.marginTop = "10px";
          a.textContent = "ğŸ‘‰ å»æ‰“ Tagï¼ˆè¿›å…¥æ‰¹æ¬¡ï¼‰";
          msg.appendChild(document.createElement("div")).appendChild(a);

          // ç»™ä½ ç•™ä¸€ç‚¹æ—¶é—´çœ‹åˆ°æç¤º
          setTimeout(() => { window.location.href = url; }, 1400);
        }
      };

      xhr.send(fd);
    });

    setFiles([]);
  })();
</script>

{% endblock %}