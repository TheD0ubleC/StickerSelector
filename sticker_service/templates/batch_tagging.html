{% extends "base.html" %}
{% block content %}
<div class="page-head">
  <div>
    <h1>æ‰¹é‡æ‰“ Tag <span class="pill">#{{ batch_id }}</span></h1>
    <div class="hint">
      {% if batch_note %}å¤‡æ³¨ï¼š{{ batch_note }}{% else %}ï¼ˆæ— å¤‡æ³¨ï¼‰{% endif %}
      Â· å¾…æ‰“ Tagï¼š<b id="pendingCount">{{ pending_count }}</b>
    </div>
  </div>
  <div class="row-line">
    <button class="btn glow" id="btnSaveAll">ä¿å­˜æœ¬é¡µä¿®æ”¹</button>
    <button class="btn secondary" id="btnReload">åˆ·æ–°</button>
    <button class="btn danger" id="btnDeleteBatch">åˆ é™¤æ‰¹æ¬¡</button>
    <a class="btn ghost" href="/admin/pending">è¿”å›å¾…æ‰“ Tag</a>
  </div>
</div>

<div class="card">
  <div class="statline">
    <span class="pill" id="statPending">pending 0</span>
    <span class="pill" id="statUnsaved">unsaved 0</span>
  </div>
</div>

<div id="batchList" class="list-stack"></div>

<script>
  (function () {
    const BATCH_ID = {{ batch_id }
  };
  const listEl = document.getElementById("batchList");
  const pendingCountEl = document.getElementById("pendingCount");
  const statPending = document.getElementById("statPending");
  const statUnsaved = document.getElementById("statUnsaved");

  const btnSaveAll = document.getElementById("btnSaveAll");
  const btnReload = document.getElementById("btnReload");
  const btnDeleteBatch = document.getElementById("btnDeleteBatch");

  const edits = new Map();

  function showToast(text, sub) {
    if (typeof toast === "function") {
      if (typeof sub === "number") {
        toast(text);
      } else {
        toast(text, sub || "");
      }
    }
  }

  function parseTags(text) {
    if (!text) return [];
    return text.split(/[\s,ï¼Œ;ï¼›|]+/).map(x => x.trim()).filter(Boolean);
  }

  function tagsToText(arr) {
    return (arr || []).map(x => String(x).trim()).filter(Boolean).join(" ");
  }

  function updateStats(total) {
    const pending = total ?? (listEl.children.length || 0);
    const unsaved = edits.size;
    statPending.textContent = `pending ${pending}`;
    statPending.className = "pill " + (pending > 0 ? "bad" : "ok");
    statUnsaved.textContent = `unsaved ${unsaved}`;
    statUnsaved.className = "pill " + (unsaved > 0 ? "bad" : "");
  }

  function escapeHtml(s) {
    return String(s || "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;");
  }

  function renderRow(it) {
    const row = document.createElement("div");
    row.className = "batch-row";
    row.dataset.id = it.id;

    const tags = Array.isArray(it.tags) ? it.tags : [];
    const tagsText = tagsToText(tags);

    row.innerHTML = `
        <div class="batch-thumb"><img src="${it.url}" loading="lazy" /></div>
        <div class="batch-meta">
          <div class="row-line">
            <span class="pill">#${it.id}</span>
            <span class="muted">${escapeHtml(it.series || "")}</span>
          </div>
          <div class="muted small">batch: ${it.batch_id ?? ""}</div>
          <div class="row mt8">
            <label>Tagsï¼ˆç©ºæ ¼/é€—å·/æ¢è¡Œåˆ†éš”ï¼‰</label>
            <textarea class="textarea" rows="2" data-role="tags">${escapeHtml(tagsText)}</textarea>
          </div>
          <div class="row-line mt8">
            <label class="muted">å¯ç”¨</label>
            <select data-role="enabled">
              <option value="1"${it.enabled ? " selected" : ""}>å¯ç”¨</option>
              <option value="0"${!it.enabled ? " selected" : ""}>ç¦ç”¨</option>
            </select>
            <div class="spacer"></div>
            <a class="btn small ghost" href="/admin/sticker/${it.id}" target="_blank">è¯¦æƒ…</a>
            <button class="btn small danger" data-act="del">åˆ é™¤</button>
          </div>
        </div>
      `;

    const input = row.querySelector('[data-role="tags"]');
    const sel = row.querySelector('[data-role="enabled"]');
    input.addEventListener("input", () => {
      edits.set(it.id, { tags: parseTags(input.value), enabled: (sel.value === "1") });
      updateStats();
    });
    sel.addEventListener("change", () => {
      edits.set(it.id, { tags: parseTags(input.value), enabled: (sel.value === "1") });
      updateStats();
    });

    row.querySelector('[data-act="del"]').addEventListener("click", async () => {
      await deleteSticker(it.id, row);
    });

    return row;
  }

  async function load() {
    listEl.innerHTML = `<div class="card muted">åŠ è½½ä¸­â€¦</div>`;
    const res = await fetch(`/api/pending?batch_id=${BATCH_ID}&limit=5000`);
    const data = await res.json();
    const items = data.items || [];
    pendingCountEl.textContent = (data.meta && data.meta.count) ? data.meta.count : items.length;
    edits.clear();

    if (items.length === 0) {
      listEl.innerHTML = `<div class="card"><div class="muted">è¿™ä¸ªæ‰¹æ¬¡å·²ç»æ²¡æœ‰å¾…æ‰“ Tag çš„å›¾ç‰‡äº† âœ…</div></div>`;
      updateStats(0);
      return;
    }

    listEl.innerHTML = "";
    for (const it of items) {
      listEl.appendChild(renderRow(it));
    }
    updateStats(items.length);
  }

  async function saveAll() {
    if (edits.size === 0) {
      showToast("æ²¡æœ‰ä¿®æ”¹å†…å®¹éœ€è¦ä¿å­˜");
      return;
    }
    btnSaveAll.disabled = true;
    btnSaveAll.textContent = "ä¿å­˜ä¸­â€¦";

    const payload = { items: [] };
    for (const [id, v] of edits.entries()) {
      payload.items.push({ id, tags: v.tags || [], enabled: !!v.enabled });
    }

    try {
      const res = await fetch("/api/stickers/bulk_update", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      if (!data.ok) {
        showToast("ä¿å­˜å¤±è´¥ï¼š" + (data.detail || "unknown"), 2200);
        return;
      }
      showToast(`âœ… ä¿å­˜å®Œæˆï¼šæ›´æ–° ${data.updated || 0} æ¡`);
      edits.clear();
      await load();
      if (typeof refreshBadge === "function") refreshBadge();
    } catch (e) {
      showToast("ä¿å­˜å¤±è´¥ï¼šç½‘ç»œé”™è¯¯", 2200);
    } finally {
      btnSaveAll.disabled = false;
      btnSaveAll.textContent = "ä¿å­˜æœ¬é¡µä¿®æ”¹";
    }
  }

  async function deleteSticker(id, row) {
    if (!confirm(`ç¡®å®šåˆ é™¤è¿™å¼ è¡¨æƒ…åŒ…ï¼Ÿ\n#${id}\nï¼ˆä¼šåŒæ—¶åˆ é™¤å›¾ç‰‡æ–‡ä»¶ï¼Œæ— æ³•æ¢å¤ï¼‰`)) return;
    const btn = row.querySelector('[data-act="del"]');
    btn.disabled = true;
    btn.textContent = "åˆ é™¤ä¸­â€¦";
    try {
      const res = await fetch("/api/sticker/delete", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id })
      });
      const data = await res.json();
      if (!data.ok) {
        showToast("åˆ é™¤å¤±è´¥ï¼š" + (data.detail || "unknown"), 2200);
        btn.disabled = false;
        btn.textContent = "åˆ é™¤";
        return;
      }
      edits.delete(id);
      row.remove();
      showToast(`ğŸ—‘ï¸ å·²åˆ é™¤ï¼š#${id}`);
      const cur = parseInt(pendingCountEl.textContent || "0", 10) || 0;
      pendingCountEl.textContent = String(Math.max(0, cur - 1));
      updateStats();
      if (typeof refreshBadge === "function") refreshBadge();
    } catch (e) {
      showToast("åˆ é™¤å¤±è´¥ï¼šç½‘ç»œé”™è¯¯", 2200);
    }
  }

  async function deleteBatch() {
    if (!confirm(`ç¡®å®šåˆ é™¤æ•´ä¸ªæ‰¹æ¬¡ï¼Ÿ\nBatch #${BATCH_ID}\nï¼ˆä¼šåˆ é™¤è¯¥æ‰¹æ¬¡å†…æ‰€æœ‰è¡¨æƒ…åŒ…å’Œå›¾ç‰‡æ–‡ä»¶ï¼Œæ— æ³•æ¢å¤ï¼‰`)) return;
    btnDeleteBatch.disabled = true;
    btnDeleteBatch.textContent = "åˆ é™¤ä¸­â€¦";
    try {
      const res = await fetch("/api/batch/delete", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ batch_id: BATCH_ID })
      });
      const data = await res.json();
      if (!data.ok) {
        showToast("åˆ é™¤æ‰¹æ¬¡å¤±è´¥ï¼š" + (data.detail || "unknown"), 2200);
        return;
      }
      showToast(`âœ… å·²åˆ é™¤æ‰¹æ¬¡ï¼š#${BATCH_ID}ï¼ˆåˆ é™¤ ${data.deleted_stickers || 0} å¼ ï¼‰`, 1200);
      setTimeout(() => { window.location.href = "/admin/pending"; }, 700);
    } catch (e) {
      showToast("åˆ é™¤æ‰¹æ¬¡å¤±è´¥ï¼šç½‘ç»œé”™è¯¯", 2200);
    } finally {
      btnDeleteBatch.disabled = false;
      btnDeleteBatch.textContent = "åˆ é™¤æ‰¹æ¬¡";
    }
  }

  btnSaveAll.addEventListener("click", saveAll);
  btnReload.addEventListener("click", (e) => { e.preventDefault(); load(); });
  btnDeleteBatch.addEventListener("click", deleteBatch);

  window.addEventListener("beforeunload", (e) => {
    if (edits.size > 0) {
      e.preventDefault();
      e.returnValue = "";
    }
  });

  load();
  }) ();
</script>
{% endblock %}